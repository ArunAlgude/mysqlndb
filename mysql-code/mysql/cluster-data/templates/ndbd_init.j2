#!/bin/sh
# Linux Standard Base comments
### BEGIN INIT INFO
# Provides:          ndbd
# Required-Start:    $local_fs $network $syslog $remote_fs
# Required-Stop:     $local_fs $network $syslog $remote_fs
# Should-Start:
# Should-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: mysql cluster manager client
# Description:       mysql cluster manager client
### END INIT INFO

DESC="SQL Data Node service"
NAME=ndbmtd

# Load the VERBOSE setting and other rcS variables
. /lib/init/vars.sh

# Define LSB log_* functions.
# Depend on lsb-base (>= 3.2-14) to ensure that this file is present
# and status_of_proc is working.
. /lib/lsb/init-functions

ndbd_bin=/usr/local/bin/ndbmtd

if ! test -x $ndbd_bin; then
	echo "Can't execute $ndbd_bin";
	exit;
fi

start_ndbd()
{
	number_of_ndbd_pids=`ps aux|grep -iv "grep"|grep -i $NAME|wc -l`
	if [ $number_of_ndbd_pids -eq 0 ]; then
		sudo -u mysql $ndbd_bin --ndb-nodeid={{ mySQL_DataNode_ID }} --ndb-connectstring={% for host in groups['mysql_cluster_mgm'] %}{{ hostvars[host].ansible_default_ipv4.address }}:1186{% if not loop.last %},{% endif %}{% endfor %} > /tmp/log
		echo sudo -u mysql $ndbd_bin --ndb-nodeid={{ mySQL_DataNode_ID }} --ndb-connectstring={% for host in groups['mysql_cluster_mgm'] %}{{ hostvars[host].ansible_default_ipv4.address }}:1186{% if not loop.last %},{% endif %}{% endfor %} >> /tmp/log
		echo "ndbd started."
	else
		echo "ndbd is already running."
	fi
}

stop_ndbd()
{
	number_of_ndbd_pids=`ps aux|grep -iv "grep"|grep -i $NAME|wc -l`
  if [ $number_of_ndbd_pids -ne 0 ]; then
		ndbd_pids=`pgrep ndbmtd`
			for ndbd_pid in $(echo $ndbd_pids); do
				kill $ndbd_pid 2> /dev/null
      done
    sleep 10
		number_of_ndbd_pids=`ps aux|grep -iv "grep"|grep -i $NAME|wc -l`
    	if [ $number_of_ndbd_pids -eq 0 ]; then
      	echo "ndbd stopped."
      else
				echo "Could not stop ndbd."
			fi
	else
		echo "ndbd is not running."
	fi
}


case "$1" in
    'start' )
			start_ndbd
        ;;
    'stop' )
			stop_ndbd
        ;;
    'restart' )
      stop_ndbd
			start_ndbd
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}" >&2
        ;;
esac

exit 0
